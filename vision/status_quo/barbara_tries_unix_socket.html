<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Barbara tries Unix socket - wg-async-foundations</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../welcome.html"><strong aria-hidden="true">1.</strong> üëãüèΩ Welcome</a></li><li class="chapter-item expanded "><a href="../../vision.html"><strong aria-hidden="true">2.</strong> üîÆ The vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision.html"><strong aria-hidden="true">2.1.</strong> ‚ùìHow to vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision/projects.html"><strong aria-hidden="true">2.1.1.</strong> Projects</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">2.1.2.</strong> &quot;Status quo&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">2.1.3.</strong> &quot;Shiny future&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/comment.html"><strong aria-hidden="true">2.1.4.</strong> Commenting</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/awards.html"><strong aria-hidden="true">2.1.5.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../vision/tenets.html"><strong aria-hidden="true">2.2.</strong> ‚úèÔ∏è Design tenets for async</a></li><li class="chapter-item "><a href="../../vision/characters.html"><strong aria-hidden="true">2.3.</strong> üôã‚Äç‚ôÄÔ∏è Cast of characters</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/characters/alan.html"><strong aria-hidden="true">2.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../vision/characters/grace.html"><strong aria-hidden="true">2.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../vision/characters/niklaus.html"><strong aria-hidden="true">2.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../vision/characters/barbara.html"><strong aria-hidden="true">2.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../vision/projects.html"><strong aria-hidden="true">2.4.</strong> ‚ö° Projects</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/projects/template.html"><strong aria-hidden="true">2.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">2.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../vision/projects/DistriData.html"><strong aria-hidden="true">2.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">2.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/YouBuy.html"><strong aria-hidden="true">2.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../vision/projects/SLOW.html"><strong aria-hidden="true">2.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision/status_quo.html"><strong aria-hidden="true">2.5.</strong> üò± Status quo</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/status_quo/template.html"><strong aria-hidden="true">2.5.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">2.5.2.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">2.5.3.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">2.5.4.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">2.5.5.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">2.5.6.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">2.5.7.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">2.5.8.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">2.5.9.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">2.5.10.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">2.5.11.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">2.5.12.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">2.5.13.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">2.5.14.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">2.5.15.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer.html"><strong aria-hidden="true">2.5.16.</strong> Alan extends an AWS service</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/writing_a_java_based_service.html"><strong aria-hidden="true">2.5.16.1.</strong> Writing a Java-based service at AWS</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/getting_started_with_rust.html"><strong aria-hidden="true">2.5.16.2.</strong> Getting started with Rust</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/coming_from_java.html"><strong aria-hidden="true">2.5.16.3.</strong> Coming from Java</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/ecosystem.html"><strong aria-hidden="true">2.5.16.4.</strong> Exploring the ecosystem</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/juggling_error_handling.html"><strong aria-hidden="true">2.5.16.5.</strong> Juggling error handling</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/failure_to_parallelize.html"><strong aria-hidden="true">2.5.16.6.</strong> Failure to parallelize</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/borrow_check_errors.html"><strong aria-hidden="true">2.5.16.7.</strong> Borrow check errors</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/encountering_pin.html"><strong aria-hidden="true">2.5.16.8.</strong> Encoutering pin</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/figuring_out_the_best_option.html"><strong aria-hidden="true">2.5.16.9.</strong> Figuring out the best option</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/testing_the_service.html"><strong aria-hidden="true">2.5.16.10.</strong> Testing his service</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/missed_waker_leads_to_lost_performance.html"><strong aria-hidden="true">2.5.16.11.</strong> Missed Waker leads to lost performance</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/debugging_performance_problems.html"><strong aria-hidden="true">2.5.16.12.</strong> Debugging performance problems</a></li><li class="chapter-item "><a href="../../vision/status_quo/aws_engineer/using_jni.html"><strong aria-hidden="true">2.5.16.13.</strong> Using JNI</a></li></ol></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">2.5.17.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_battles_buffered_streams.html"><strong aria-hidden="true">2.5.18.</strong> Barbara battles buffered streams</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">2.5.19.</strong> Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">2.5.20.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">2.5.21.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">2.5.22.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_gets_burned_by_select.html"><strong aria-hidden="true">2.5.23.</strong> Barbara gets burned by select</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">2.5.24.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">2.5.25.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">2.5.26.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">2.5.27.</strong> Barbara tries async streams</a></li><li class="chapter-item expanded "><a href="../../vision/status_quo/barbara_tries_unix_socket.html" class="active"><strong aria-hidden="true">2.5.28.</strong> Barbara tries Unix socket</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">2.5.29.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">2.5.30.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">2.5.31.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_writes_a_runtime_agnostic_lib.html"><strong aria-hidden="true">2.5.32.</strong> Barbara writes a runtime-agnostic library</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">2.5.33.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">2.5.34.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">2.5.35.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">2.5.36.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_writes_a_new_fb_service.html"><strong aria-hidden="true">2.5.37.</strong> Grace writes a new Facebook service</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">2.5.38.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">2.5.39.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../vision/shiny_future.html"><strong aria-hidden="true">2.6.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/shiny_future/template.html"><strong aria-hidden="true">2.6.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alan_learns_async_on_his_own.html"><strong aria-hidden="true">2.6.2.</strong> Alan learns async on his own</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">2.6.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">2.6.4.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../vision/shiny_future/barbara_appreciates_performance_tools.html"><strong aria-hidden="true">2.6.5.</strong> Barbara appreciates great performance analysis tools</a></li><li class="chapter-item "><a href="../../vision/shiny_future/barbara_enjoys_an_async_sandwich.html"><strong aria-hidden="true">2.6.6.</strong> Barbara enjoys an async sandwich</a></li><li class="chapter-item "><a href="../../vision/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">2.6.7.</strong> Barbara makes a wish</a></li><li class="chapter-item "><a href="../../vision/shiny_future/barbara_wants_async_rw.html"><strong aria-hidden="true">2.6.8.</strong> Barbara wants async read write</a></li><li class="chapter-item "><a href="../../vision/shiny_future/barbara_wants_async_tracing.html"><strong aria-hidden="true">2.6.9.</strong> Barbara wants async tracing</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap.html"><strong aria-hidden="true">2.7.</strong> üìÖ Roadmap for 2021</a></li></ol></li><li class="chapter-item "><a href="../../triage.html"><strong aria-hidden="true">3.</strong> üîç Triage meetings</a></li><li class="chapter-item "><a href="../../design_docs.html"><strong aria-hidden="true">4.</strong> üî¨ Design docs</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/yield_safe.html"><strong aria-hidden="true">4.1.</strong> ‚ö†Ô∏è Yield-safe lint</a></li><li class="chapter-item "><a href="../../design_docs/stream.html"><strong aria-hidden="true">4.2.</strong> ‚òî Stream trait</a></li><li class="chapter-item "><a href="../../design_docs/generator_syntax.html"><strong aria-hidden="true">4.3.</strong> ‚ö° Generator syntax</a></li><li class="chapter-item "><a href="../../design_docs/async_read_write.html"><strong aria-hidden="true">4.4.</strong> üìù AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">4.5.</strong> üß¨ Async fn in traits</a></li><li class="chapter-item "><a href="../../design_docs/mutex.html"><strong aria-hidden="true">4.6.</strong> üîí Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../design_docs/channels.html"><strong aria-hidden="true">4.7.</strong> üì∫ Async aware channels</a></li><li class="chapter-item "><a href="../../design_docs/async_closures.html"><strong aria-hidden="true">4.8.</strong> üì¶ Async closures</a></li><li class="chapter-item "><a href="../../design_docs/join.html"><strong aria-hidden="true">4.9.</strong> ü§ù Join combinator</a></li><li class="chapter-item "><a href="../../design_docs/select.html"><strong aria-hidden="true">4.10.</strong> ü§∑‚Äç‚ôÄÔ∏è Select combinator</a></li><li class="chapter-item "><a href="../../design_docs/sink_trait.html"><strong aria-hidden="true">4.11.</strong> üö∞ Sink trait</a></li><li class="chapter-item "><a href="../../design_docs/async_main.html"><strong aria-hidden="true">4.12.</strong> üéá Async main</a></li><li class="chapter-item "><a href="../../design_docs/async_drop.html"><strong aria-hidden="true">4.13.</strong> üóëÔ∏è Async drop</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/async_lifecycle.html"><strong aria-hidden="true">4.13.1.</strong> ‚ôªÔ∏è Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../design_docs/completion_based_futures.html"><strong aria-hidden="true">4.14.</strong> ‚è≥ Completion-based futures</a></li></ol></li><li class="chapter-item "><a href="../../conversations.html"><strong aria-hidden="true">5.</strong> üí¨ Conversations</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">5.1.</strong> üê¶ 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../acknowledgments.html"><strong aria-hidden="true">6.</strong> ‚ù§Ô∏è Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">wg-async-foundations</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/rust-lang/wg-async-foundations" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-stories-barbara-tries-unix-socket"><a class="header" href="#-status-quo-stories-barbara-tries-unix-socket">üò± Status quo stories: Barbara tries Unix socket</a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">üöß Warning: Draft status üöß</a></h2>
<p>This is a draft &quot;status quo&quot; story submitted as part of the brainstorming period. It is derived from real-life experiences of actual Rust users and is meant to reflect some of the challenges that Async Rust programmers face today. </p>
<p>If you would like to expand on this story, or adjust the answers to the FAQ, feel free to open a PR making edits (but keep in mind that, as they reflect peoples' experiences, status quo stories <a href="../how_to_vision/comment.html#comment-to-understand-or-improve-not-to-negate-or-dissuade">cannot be wrong</a>, only inaccurate). Alternatively, you may wish to <a href="../how_to_vision/status_quo.html">add your own status quo story</a>!</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<p>Content of <code>Cargo.toml</code> for reproducibility:</p>
<details>
  <summary><code>Cargo.toml</code></summary>
<pre><code class="language-toml">futures = &quot;0.3.14&quot;
hyper = { version = &quot;0.14.7&quot;, features = [&quot;full&quot;] }
pretty_env_logger = &quot;0.4.0&quot;
reqwest = &quot;0.11.3&quot;
tokio = { version = &quot;1.5.0&quot;, features = [&quot;macros&quot;, &quot;rt-multi-thread&quot;] }
</code></pre>
</details>
<p>There is a HTTP server in hyper which Barbara have to query.</p>
<details>
  <summary>Server code</summary>
<pre><pre class="playground"><code class="language-rust edition2018">use hyper::server::conn::Http;
use hyper::service::service_fn;
use hyper::{Body, Request, Response};
use std::convert::Infallible;
use tokio::net::TcpListener;

#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    let listener = TcpListener::bind(&quot;127.0.0.1:3000&quot;).await?;
 
    loop {
        let (stream, _) = listener.accept().await?;
 
        tokio::spawn(async move {
            let _ = Http::new()  
                .serve_connection(stream, service_fn(serve))
                .await;
        });
    }
}
 
async fn serve(_req: Request&lt;Body&gt;) -&gt; Result&lt;Response&lt;Body&gt;, Infallible&gt; {
    let res = Response::builder()
        .header(&quot;content-type&quot;, &quot;text/plain; charset=utf-8&quot;)
        .body(Body::from(&quot;Hello World!&quot;))
        .unwrap();
    Ok(res)
}
</code></pre></pre>
</details>
<h2 id="nice-simple-query-with-high-level-reqwest"><a class="header" href="#nice-simple-query-with-high-level-reqwest">Nice simple query with high-level reqwest</a></h2>
<p>Barbara do HTTP GET request using TCP socket with reqwest and it works fine, everything is easy.</p>
<pre><pre class="playground"><code class="language-rust edition2018">#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    let res = reqwest::get(&quot;http://127.0.0.1:3000&quot;).await?;
    println!(&quot;{}&quot;, res.text().await?);
    Ok(()) 
}
</code></pre></pre>
<h2 id="unix-sockets-for-performance"><a class="header" href="#unix-sockets-for-performance">Unix sockets for performance</a></h2>
<p>One day, Barbara heard that using unix socket can provide a better performance by using unix socket when both the server and client is on the same machine, so Barbara decided to try it out.</p>
<p>Barbara starts porting the server code to use unix socket, it was a no brainer for Barbara at least. Barbara changed <code>TcpListener::bind(&quot;127.0.0.1:3000&quot;).await?</code> to <code>UnixListener::bind(&quot;/tmp/socket&quot;)?</code> and it works like a charm.</p>
<p>Barbara search through reqwest doc and github issues to see how to use unix socket for reqwest. Barbara found https://github.com/seanmonstar/reqwest/issues/39#issuecomment-778716774 saying reqwest does not support unix socket but hyper does with an example, which is a lower-level library. Since reqwest is so easy and porting hyper server to use unix socket is easy, Barbara thinks low-level hyper library should be easy too.</p>
<h2 id="the-screen-stares-at-barbara"><a class="header" href="#the-screen-stares-at-barbara">The screen stares at Barbara</a></h2>
<pre><pre class="playground"><code class="language-rust edition2018">use hyper::{body::HttpBody, client::conn, Body, Request};
use tokio::net::UnixStream;

#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    pretty_env_logger::init();
    let stream = UnixStream::connect(&quot;/tmp/socket&quot;).await?;

    let (mut request_sender, connection) = conn::handshake(stream).await?;
 
    let request = Request::get(&quot;/&quot;).body(Body::empty())?;
    let mut response = request_sender.send_request(request).await?;
    println!(&quot;{:?}&quot;, response.body_mut().data().await);
 
    let request = Request::get(&quot;/&quot;).body(Body::empty())?;
    let mut response = request_sender.send_request(request).await?;
    println!(&quot;{:?}&quot;, response.body_mut().data().await);
 
    Ok(())
}
</code></pre></pre>
<p>Barbara wrote some code according to the comments Barbara saw and read some docs like what is <code>handshake</code> to roughly know what it does. Barbara compile and it shows a warning, the <code>connection</code> variable is not used:</p>
<pre><code>warning: unused variable: `connection`
 --&gt; src/main.rs:9:30
  |
9 |     let (mut request_sender, connection) = conn::handshake(stream).await?;
  |                              ^^^^^^^^^^ help: if this is intentional, prefix it with an underscore: `_connection`
  |
  = note: `#[warn(unused_variables)]` on by default
</code></pre>
<p>Barbara then runs the program. Barbara stares at the screen and the screen stares at her. Barbara waited and ... it was stuck. So Barbara decides to look at the logs and run it again with <code>env RUST_LOG=trace cargo r</code>, and it was indeed stuck, but not sure where.</p>
<pre><code> TRACE mio::poll &gt; registering event source with poller: token=Token(0), interests=READABLE | WRITABLE
</code></pre>
<p>Barbara try adding <code>println!</code> all over the code but it was still stuck, so Barbara try asking for help. Thanks to the welcoming Rust community, Barbara got help quickly in this case. It seemed like Barbara missed the <code>connection</code> which is a culprit and it was in the parent module of the docs Barbara read.</p>
<p>Barbara added the missing piece to <code>.await</code> for the <code>connection</code>, all the while Barbara thought it will work if it was <code>.await</code>-ed but in this case having required to await something else to work is a surprise. Someone suggests to Barbara that she follow the example in the docs to insert a <code>tokio::spawn</code>, so she winds up with:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    let (mut request_sender, connection) = conn::handshake(stream).await?;

    tokio::spawn(async move {
        if let Err(e) = connection.await {
            eprintln!(&quot;error: {}&quot;, e);
        }
    })
    
    let request = ...
<span class="boring">}
</span></code></pre></pre>
<p>Barbara run the code and it works now, yay! Barbara want to try to reuse the connection to send subsequent HTTP request. Barbara duplicates the last block and it runs.</p>
<h2 id="mysterious-second-request"><a class="header" href="#mysterious-second-request">Mysterious second request</a></h2>
<p>Some time later, Barbara was told that the program did not work on second request. Barbara tried it but it works. To double confirm, when Barbara tried it again it did not work. Rather than getting stuck, this time there is a error message, which is somewhat better but Barbara did not understand.</p>
<p>The second request is so mysterious, it is like the second request playing hide and seek with Barbara. Sometimes it works and sometimes it does not work.</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span> TRACE mio::poll &gt; registering event source with poller: token=Token(0), interests=READABLE | WRITABLE
Some(Ok(b&quot;Hello World!&quot;))
 TRACE want      &gt; signal: Want
 TRACE mio::poll &gt; deregistering event source from poller
 TRACE want      &gt; signal: Closed
Error: hyper::Error(Canceled, &quot;connection was not ready&quot;)
<span class="boring">}
</span></code></pre></pre>
<p>As a typical method of solving asynchronous issue. Barbara add prints to every await boundaries in the source code to understand what is going on.</p>
<pre><pre class="playground"><code class="language-rust edition2018">use hyper::{body::HttpBody, client::conn, Body, Request};
use tokio::net::UnixStream;

#[tokio::main]
async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
    pretty_env_logger::init();
    let stream = UnixStream::connect(&quot;/tmp/socket&quot;).await?;

    let (mut request_sender, connection) = conn::handshake(stream).await?;
    println!(&quot;connected&quot;); 
                        
    tokio::spawn(async move {
        if let Err(e) = connection.await {
            println!(&quot;closed&quot;); 
            eprintln!(&quot;error: {}&quot;, e);
        }
        println!(&quot;closed&quot;); 
    });
                  
    let request = Request::get(&quot;/&quot;).body(Body::empty())?;
    let mut response = request_sender.send_request(request).await?;
    println!(&quot;{:?}&quot;, response.body_mut().data().await);
                  
    let request = Request::get(&quot;/&quot;).body(Body::empty())?;
    println!(&quot;sending 2&quot;);
    let mut response = request_sender.send_request(request).await?;
    println!(&quot;sent 2&quot;); 
    println!(&quot;{:?}&quot;, response.body_mut().data().await);
                     
    Ok(())
}                    
</code></pre></pre>
<p>The logs are now more detailed. Barbara can see that the connection was closed but why? Barbara had no idea and Barbara had to seek help again.</p>
<pre><code> TRACE mio::poll &gt; registering event source with poller: token=Token(0), interests=READABLE | WRITABLE
connected
Some(Ok(b&quot;Hello World!&quot;))
sending 2
 TRACE want      &gt; signal: Want
 TRACE mio::poll &gt; deregistering event source from poller
 TRACE want      &gt; signal: Closed
closed
Error: hyper::Error(Canceled, &quot;connection was not ready&quot;)
</code></pre>
<p>This time as well, Barbara was lucky enough to get a quick reply from the welcoming Rust community. Other users said there is a trick for these kind of cases, which is a tracing stream.</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::pin::Pin;
use std::task::{Context, Poll};
use tokio::io::{AsyncRead, AsyncWrite, ReadBuf};
        
pub struct TracingStream&lt;S&gt; {
    pub inner: S,
}

impl&lt;S: AsyncRead + AsyncWrite + Unpin&gt; AsyncRead for TracingStream&lt;S&gt; {
    fn poll_read(
        mut self: Pin&lt;&amp;mut Self&gt;,
        cx: &amp;mut Context&lt;'_&gt;,
        buf: &amp;mut ReadBuf&lt;'_&gt;,
    ) -&gt; Poll&lt;Result&lt;(), std::io::Error&gt;&gt; {
        let poll_result = Pin::new(&amp;mut self.inner).poll_read(cx, buf);
        for line in String::from_utf8_lossy(buf.filled()).into_owned().lines() {
            println!(&quot;&gt; {}&quot;, line);
        }
        poll_result
    }
}
                                 
impl&lt;S: AsyncRead + AsyncWrite + Unpin&gt; AsyncWrite for TracingStream&lt;S&gt; {
    fn poll_flush(
        mut self: Pin&lt;&amp;mut Self&gt;,
        cx: &amp;mut Context&lt;'_&gt;,
    ) -&gt; Poll&lt;Result&lt;(), std::io::Error&gt;&gt; {
        Pin::new(&amp;mut self.inner).poll_flush(cx)
    } 
    
    fn poll_shutdown(
        mut self: Pin&lt;&amp;mut Self&gt;,
        cx: &amp;mut Context&lt;'_&gt;,
    ) -&gt; Poll&lt;Result&lt;(), std::io::Error&gt;&gt; {
        Pin::new(&amp;mut self.inner).poll_shutdown(cx)
    }
 
    fn poll_write(
        mut self: Pin&lt;&amp;mut Self&gt;,
        cx: &amp;mut Context&lt;'_&gt;,
        buf: &amp;[u8],
    ) -&gt; Poll&lt;Result&lt;usize, std::io::Error&gt;&gt; {
        let poll_result = Pin::new(&amp;mut self.inner).poll_write(cx, buf);
        for line in String::from_utf8_lossy(buf).into_owned().lines() {
            println!(&quot;&lt; {}&quot;, line);
        }
        poll_result
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Barbara happily copy pasted the code and wrap the <code>stream</code> within <code>TracingStream</code>. Running it with logs gives (same thing, in some cases it works, in some cases it did not work):</p>
<pre><code> TRACE mio::poll &gt; registering event source with poller: token=Token(0), interests=READABLE | WRITABLE
connected
&lt; GET / HTTP/1.1
&lt; 
&gt; HTTP/1.1 200 OK
&gt; content-type: text/plain; charset=utf-8
&gt; content-length: 12
&gt; date: Tue, 04 May 2021 17:02:49 GMT
&gt; 
&gt; Hello World!
Some(Ok(b&quot;Hello World!&quot;))
sending 2
 TRACE want      &gt; signal: Want
 TRACE want      &gt; signal: Want
 TRACE mio::poll &gt; deregistering event source from poller
 TRACE want      &gt; signal: Closed
closed
Error: hyper::Error(Canceled, &quot;connection was not ready&quot;)
</code></pre>
<p>Barbara thought this probably only affects a unix socket but nope, even swapping it back with TCP socket does not work either. Now, not just Barbara was confused, even the other developers who offered help was confused now.</p>
<h2 id="the-single-magical-line"><a class="header" href="#the-single-magical-line">The single magical line</a></h2>
<p>After some time, a developer found a solution, just a single line. Barbara added the line and it works like a charm but it still feels like magic.</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use futures::future;

    // this new line below was added for second request
    future::poll_fn(|cx| request_sender.poll_ready(cx)).await?;
    let request = Request::get(&quot;/&quot;).body(Body::empty())?;
    println!(&quot;sending 2&quot;);
    let mut response = request_sender.send_request(request).await?;
    println!(&quot;sent 2&quot;);
    println!(&quot;{:?}&quot;, response.body_mut().data().await);
<span class="boring">}
</span></code></pre></pre>
<p>Barbara still have no idea why it needs to be done this way. But at least it works now.</p>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">ü§î Frequently Asked Questions</a></h2>
<h3 id="what-are-the-morals-of-the-story"><a class="header" href="#what-are-the-morals-of-the-story"><strong>What are the morals of the story?</strong></a></h3>
<p>Barbara is not able to see the problem right away. Usually missing an <code>await</code> is an issue but in this case, not awaiting on another variable or not polling for ready when using a low-level library may the program incorrect, it is also hard to debug and figure out what is the correct solution.</p>
<p>In a way, some of the fixes &quot;feels like magic&quot;. Sometimes polling is required to be done but where? It may make people afraid of using <code>async/.await</code> and end up writing safety net code (for example, writing code to do type checking in weakly typed languages in every lines of code to be safe).</p>
<p>Having these pitfalls in mind, one can easily relate it back to unsafe. If there are unsafe blocks, the user needs to manually audit every specific code block for undefined behaviors. But in the case of async, the situation is someone similar such that the user need to audit the whole async code blocks (which is a lot compared to unsafe) for &quot;undefined behaviors&quot;, rather than having when it compiles it works sort of behavior.</p>
<h3 id="what-are-the-sources-for-this-story"><a class="header" href="#what-are-the-sources-for-this-story"><strong>What are the sources for this story?</strong></a></h3>
<p>pickfire was experimenting with HTTP client over unix socket and faced this issue as he though it is easy, still a lot thanks to Programatik for helping out with a quick and helpful response.</p>
<h3 id="why-did-you-choose-barbara-to-tell-this-story"><a class="header" href="#why-did-you-choose-barbara-to-tell-this-story"><strong>Why did you choose <em>Barbara</em> to tell this story?</strong></a></h3>
<p>Barbara have some experience with synchronous and high-level asynchronous rust libraries but not with low-level asynchronous libraries.</p>
<h3 id="how-would-this-story-have-played-out-differently-for-the-other-characters"><a class="header" href="#how-would-this-story-have-played-out-differently-for-the-other-characters"><strong>How would this story have played out differently for the other characters?</strong></a></h3>
<p>Most likely everyone could have faced the same issue unless they are lucky.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../vision/status_quo/barbara_tries_async_streams.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../vision/status_quo/barbara_trims_a_stacktrace.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../vision/status_quo/barbara_tries_async_streams.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../vision/status_quo/barbara_trims_a_stacktrace.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
